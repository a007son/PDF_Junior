<!DOCTYPE html>
<html lang="zh-Hant" class="spectrum spectrum--light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Junior</title>
    
    <!-- 1. PDF.js (v3.11.174) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- 2. PDF-Lib -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    
    <!-- Material Icons (用於模擬圖示，Spectrum 風格化) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <style>
        :root {
            /* Spectrum Color Palette Simulation */
            --spectrum-global-color-gray-50: #f5f5f5;
            --spectrum-global-color-gray-100: #eaeaea;
            --spectrum-global-color-gray-200: #e1e1e1;
            --spectrum-global-color-gray-300: #d5d5d5;
            --spectrum-global-color-gray-400: #b6b6b6;
            --spectrum-global-color-gray-500: #909090;
            --spectrum-global-color-gray-600: #6e6e6e; /* Added for darker gray text */
            --spectrum-global-color-gray-800: #464646;
            --spectrum-global-color-gray-900: #2c2c2c;

            --spectrum-global-color-blue-400: #2680eb;
            --spectrum-global-color-blue-500: #1473e6; /* Adobe Blue */
            --spectrum-global-color-blue-600: #0d66d0;
            
            --spectrum-global-color-red-400: #ec5b62;
            --spectrum-global-color-red-500: #d7373f;
            
            --spectrum-alias-background-color-default: #ffffff;
            --spectrum-alias-text-color: var(--spectrum-global-color-gray-900);
            
            --border-radius-medium: 4px;
            --border-radius-large: 16px;
            
            --font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--spectrum-global-color-gray-50);
            color: var(--spectrum-alias-text-color);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- Spectrum Header --- */
        .spectrum-header {
            background: var(--spectrum-alias-background-color-default);
            border-bottom: 1px solid var(--spectrum-global-color-gray-200);
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 18px;
            color: var(--spectrum-global-color-gray-900);
        }
        
        /* 模擬 Adobe Logo 方塊 */
        .brand-icon {
            width: 28px;
            height: 28px;
            background-color: var(--spectrum-global-color-red-500);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            border-radius: 4px;
        }

        /* --- Spectrum Tabs --- */
        .spectrum-tabs {
            display: flex;
            gap: 24px;
            margin-left: 40px;
            height: 100%;
        }

        .tab-item {
            display: flex;
            align-items: center;
            height: 100%;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--spectrum-global-color-gray-500);
            position: relative;
            transition: color 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab-item:hover { color: var(--spectrum-global-color-gray-800); }
        
        .tab-item.selected {
            color: var(--spectrum-global-color-gray-900);
            border-bottom: 2px solid var(--spectrum-global-color-blue-500);
        }

        /* --- Main Content --- */
        .main-container {
            max-width: 1200px;
            margin: 32px auto;
            width: 90%;
            flex: 1;
        }

        .panel { display: none; animation: fadeIn 0.3s ease; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Upload Zone (Spectrum Dropzone) --- */
        .dropzone {
            border: 2px dashed var(--spectrum-global-color-gray-300);
            border-radius: var(--border-radius-medium);
            background-color: var(--spectrum-alias-background-color-default);
            padding: 48px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .dropzone:hover {
            border-color: var(--spectrum-global-color-blue-400);
            background-color: #f8fbff;
        }

        .dropzone-icon {
            font-size: 48px;
            color: var(--spectrum-global-color-gray-400);
            margin-bottom: 16px;
            transition: color 0.2s;
        }
        
        .dropzone:hover .dropzone-icon {
            color: var(--spectrum-global-color-blue-400);			 
        }
        
        .dropzone h3 { margin: 0 0 8px 0; font-size: 18px; color: var(--spectrum-global-color-gray-800); }
        .dropzone p { margin: 0; font-size: 14px; color: var(--spectrum-global-color-gray-500); }

        /* --- Workspace & Toolbar --- */
        .toolbar {
            background-color: var(--spectrum-alias-background-color-default);
            padding: 12px 20px;
            border-radius: var(--border-radius-medium);
            border: 1px solid var(--spectrum-global-color-gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        
        .file-status {
            font-weight: 600;
            font-size: 14px;
            color: var(--spectrum-global-color-gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- Spectrum Buttons --- */
        .spectrum-btn {
            background-color: transparent;
            border: 1px solid var(--spectrum-global-color-gray-400);
            color: var(--spectrum-global-color-gray-800);
            padding: 6px 16px;
            border-radius: 16px; /* Pill shape standard in some Spectrum contexts */
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            outline: none;
        }

        .spectrum-btn:hover {
            background-color: var(--spectrum-global-color-gray-100);
            border-color: var(--spectrum-global-color-gray-800);
        }

        .spectrum-btn:active { background-color: var(--spectrum-global-color-gray-200); }

        .spectrum-btn.primary {
            background-color: var(--spectrum-global-color-blue-500);
            border-color: var(--spectrum-global-color-blue-500);
            color: white;
        }

        .spectrum-btn.primary:hover {
            background-color: var(--spectrum-global-color-blue-600);
            border-color: var(--spectrum-global-color-blue-600);
        }

        .spectrum-btn.quiet {
            border: none;
            background: transparent;
            color: var(--spectrum-global-color-gray-600);
        }
        .spectrum-btn.quiet:hover { color: var(--spectrum-global-color-gray-900); background: rgba(0,0,0,0.05); }

        .spectrum-btn.icon-only { padding: 6px; border-radius: 50%; width: 32px; height: 32px; justify-content: center; }

        /* --- Grid & Cards --- */
        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .spectrum-card {
            background: var(--spectrum-alias-background-color-default);
            border: 1px solid var(--spectrum-global-color-gray-200);
            border-radius: var(--border-radius-medium);
            overflow: hidden;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .spectrum-card:hover {
            border-color: var(--spectrum-global-color-blue-400);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .spectrum-card.dragging { opacity: 0.5; border: 2px dashed var(--spectrum-global-color-gray-400); background: #f9f9f9; }
        
        /* Drop indicators */
        .spectrum-card.insert-before { border-left: 4px solid var(--spectrum-global-color-blue-500); }
        .spectrum-card.insert-after { border-right: 4px solid var(--spectrum-global-color-blue-500); }

        /* --- 修正點：加大預覽區域與減少內距 --- */
        .card-preview {
            height: 220px;
            background-color: var(--spectrum-global-color-gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 8px; /* 減少內距 */
            position: relative;
        }
        
        /* --- 修正點：讓 Canvas 盡量佔滿 --- */
        .card-preview canvas, .card-preview img {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: transform 0.3s cubic-bezier(0.45, 0, 0.55, 1);
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .card-footer {
            padding: 12px;
            border-top: 1px solid var(--spectrum-global-color-gray-100);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
        }

        .card-title {
            font-size: 12px;
            color: var(--spectrum-global-color-gray-800);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100px;
        }

        /* Delete Selection State */
        .spectrum-card.selected {
            border: 2px solid var(--spectrum-global-color-red-500);
        }
        .spectrum-card.selected .card-preview::after {
            content: 'delete';
            font-family: 'Material Icons Outlined';
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 48px;
            color: var(--spectrum-global-color-red-500);
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            padding: 12px;
        }

        /* --- Footer Action Bar --- */
        .action-bar {
            text-align: right;
            padding-top: 24px;
            border-top: 1px solid var(--spectrum-global-color-gray-200);
        }

        /* --- Footer (New) --- */
        .spectrum-footer {
            background-color: var(--spectrum-alias-background-color-default);
            border-top: 1px solid var(--spectrum-global-color-gray-200);
            padding: 24px;
            text-align: center;
            margin-top: auto; /* Stick to bottom if content is short */
        }
        
        .footer-text {
            color: var(--spectrum-global-color-gray-600);
            font-size: 13px;
            margin: 0;
            line-height: 1.6;
        }
        
        .footer-credit {
            color: var(--spectrum-global-color-gray-500);
            font-size: 11px;
            margin-top: 8px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* --- Loaders & Notifications --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(2px);
            z-index: 1000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        
        .spectrum-loader {
            width: 32px; height: 32px;
            border: 3px solid var(--spectrum-global-color-gray-300);
            border-top-color: var(--spectrum-global-color-blue-500);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #323232; color: white;
            padding: 12px 24px; border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px; opacity: 0; transition: all 0.3s;
            z-index: 2000; display: flex; align-items: center; gap: 8px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid #2D9D78; }
        .toast.error { border-left: 4px solid #D7373F; }

        /* Utility */
        .hidden { display: none !important; }
        .material-icons-outlined { font-size: 18px; }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="spectrum-header">
        <div class="brand">
            <div class="brand-icon">P</div>
            <span>PDF Junior</span>
        </div>
        <nav class="spectrum-tabs">
            <div class="tab-item selected" onclick="app.switchTab('merge')" data-target="merge">合併檔案</div>
            <div class="tab-item" onclick="app.switchTab('delete')" data-target="delete">刪除頁面</div>
            <div class="tab-item" onclick="app.switchTab('rotate')" data-target="rotate">旋轉頁面</div>
            <div class="tab-item" onclick="app.switchTab('image')" data-target="image">圖片轉 PDF</div>
        </nav>
        <div>
            <!-- Placeholder for User/Settings if needed -->
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        
        <!-- 1. MERGE -->
        <div id="panel-merge" class="panel active">
            <div id="upload-merge" class="dropzone">
                <span class="material-icons-outlined dropzone-icon">library_add</span>
                <h3>合併多個 PDF</h3>
                <p>將檔案拖曳至此，或點擊上傳</p>
                <input type="file" id="input-merge" accept=".pdf" multiple hidden>
            </div>
            
            <div id="work-merge" class="hidden">
                <div class="toolbar">
                    <div class="file-status">
                        <span class="material-icons-outlined">description</span>
                        <span id="info-merge">已載入檔案</span>
                    </div>
                    <button class="spectrum-btn" onclick="app.reset('merge')">重新開始</button>
                </div>
                <div id="grid-merge" class="grid-view"></div>
                <div class="action-bar">
                    <button class="spectrum-btn primary" onclick="app.merge.execute()">合併並下載</button>
                </div>
            </div>
        </div>

        <!-- 2. DELETE -->
        <div id="panel-delete" class="panel">
            <div id="upload-delete" class="dropzone">
                <span class="material-icons-outlined dropzone-icon">delete_sweep</span>
                <h3>刪除 PDF 頁面</h3>
                <p>上傳檔案後點選要移除的頁面</p>
                <input type="file" id="input-delete" accept=".pdf" hidden>
            </div>
            
            <div id="work-delete" class="hidden">
                <div class="toolbar">
                    <div class="file-status">
                        <span class="material-icons-outlined">description</span>
                        <span id="info-delete">Filename.pdf</span>
                    </div>
                    <button class="spectrum-btn" onclick="app.reset('delete')">關閉檔案</button>
                </div>
                <p style="text-align:center; color:var(--spectrum-global-color-gray-500); margin-bottom:20px; font-size:14px;">
                    點擊卡片以標記為 <span style="color:var(--spectrum-global-color-red-500); font-weight:bold;">刪除</span>
                </p>
                <div id="grid-delete" class="grid-view"></div>
                <div class="action-bar">
                    <button class="spectrum-btn primary" onclick="app.delete.execute()">刪除選取頁面</button>
                </div>
            </div>
        </div>

        <!-- 3. ROTATE -->
        <div id="panel-rotate" class="panel">
            <div id="upload-rotate" class="dropzone">
                <span class="material-icons-outlined dropzone-icon">rotate_right</span>
                <h3>旋轉 PDF 頁面</h3>
                <p>調整個別頁面方向</p>
                <input type="file" id="input-rotate" accept=".pdf" hidden>
            </div>
            
            <div id="work-rotate" class="hidden">
                <div class="toolbar">
                    <div class="file-status">
                        <span class="material-icons-outlined">description</span>
                        <span id="info-rotate">Filename.pdf</span>
                    </div>
                    <button class="spectrum-btn" onclick="app.reset('rotate')">關閉檔案</button>
                </div>
                <div id="grid-rotate" class="grid-view"></div>
                <div class="action-bar">
                    <button class="spectrum-btn primary" onclick="app.rotate.execute()">儲存旋轉結果</button>
                </div>
            </div>
        </div>

        <!-- 4. IMAGE -->
        <div id="panel-image" class="panel">
            <div id="upload-image" class="dropzone">
                <span class="material-icons-outlined dropzone-icon">image</span>
                <h3>圖片轉 PDF</h3>
                <p>支援 JPG 與 PNG 格式</p>
                <input type="file" id="input-image" accept="image/png, image/jpeg" multiple hidden>
            </div>
            
            <div id="work-image" class="hidden">
                <div class="toolbar">
                    <div class="file-status">
                        <span class="material-icons-outlined">collections</span>
                        <span id="info-image">已載入圖片</span>
                    </div>
                    <button class="spectrum-btn" onclick="app.reset('image')">重新開始</button>
                </div>
                <div id="grid-image" class="grid-view"></div>
                <div class="action-bar">
                    <button class="spectrum-btn primary" onclick="app.image.execute()">轉換為 PDF</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="spectrum-footer">
        <p class="footer-text">所有操作均在本機瀏覽器完成，您的檔案不會被上傳。</p>
        <p class="footer-credit">code with Gemini 3 PRO</p>
    </footer>
    <!-- Overlay & Toast -->
    <div id="loader" class="overlay">
        <div class="spectrum-loader"></div>
        <p style="margin-top:16px; font-weight:600; color:var(--spectrum-global-color-gray-800);">處理中...</p>
    </div>
    <div id="toast" class="toast"></div>

<script>
    // Worker Setup
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    const { PDFDocument, degrees } = PDFLib;

    const app = {
        state: {
            merge: { items: [] },
            delete: { file: null, buffer: null, pages: [] },
            rotate: { file: null, buffer: null, pages: [] },
            image: { files: [] }
        },

        // --- Core UI Logic ---
        switchTab: (mod) => {
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('selected'));
            document.querySelector(`.tab-item[data-target="${mod}"]`).classList.add('selected');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${mod}`).classList.add('active');
        },

        reset: (mod) => {
            app.state[mod] = (mod === 'merge' || mod === 'image') ? { items: [], files: [] } : { file: null, buffer: null, pages: [] };
            document.getElementById(`upload-${mod}`).classList.remove('hidden');
            document.getElementById(`work-${mod}`).classList.add('hidden');
            document.getElementById(`input-${mod}`).value = '';
            document.getElementById(`grid-${mod}`).innerHTML = '';
        },

        ui: {
            loader: (show) => document.getElementById('loader').style.display = show ? 'flex' : 'none',
            toast: (msg, type='success') => {
                const t = document.getElementById('toast');
                t.innerHTML = `<span class="material-icons-outlined">${type === 'success' ? 'check_circle' : 'error'}</span> ${msg}`;
                t.className = `toast show ${type}`;
                setTimeout(() => t.classList.remove('show'), 3000);
            },
            truncate: (str) => str.length > 15 ? str.substring(0,8) + '...' + str.substring(str.length-5) : str
        },

        // --- 1. Merge Module ---
        merge: {
            init: () => {
                const zone = document.getElementById('upload-merge');
                const input = document.getElementById('input-merge');
                zone.onclick = () => input.click();
                app.setupDrag(zone, input);
                input.onchange = (e) => app.merge.process(Array.from(e.target.files));
                
                // Grid Drag logic
                const grid = document.getElementById('grid-merge');
                grid.ondragover = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
                grid.ondrop = (e) => { e.preventDefault(); document.querySelectorAll('.spectrum-card').forEach(c => c.classList.remove('insert-before', 'insert-after')); };
            },
            process: async (files) => {
                files = files.filter(f => f.type === 'application/pdf');
                if(!files.length) return;
                app.ui.loader(true);
                try {
                    const newItems = await Promise.all(files.map(async (file) => {
                        const buffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument(buffer).promise;
                        const page = await pdf.getPage(1);
                        // --- 修正點：提高渲染比例，讓大圖更清晰 (0.5 -> 0.8) ---
                        const viewport = page.getViewport({scale: 0.8}); 
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width; canvas.height = viewport.height;
                        app.fitCanvas(canvas, viewport.width, viewport.height, 0);
                        await page.render({canvasContext: canvas.getContext('2d'), viewport}).promise;
                        return { file, buffer, thumb: canvas };
                    }));
                    app.state.merge.items = [...app.state.merge.items, ...newItems];
                    app.merge.render();
                    document.getElementById('upload-merge').classList.add('hidden');
                    document.getElementById('work-merge').classList.remove('hidden');
                    document.getElementById('info-merge').textContent = `${app.state.merge.items.length} 份文件`;
                } catch(e) { console.error(e); app.ui.toast('讀取失敗', 'error'); } 
                finally { app.ui.loader(false); }
            },
            render: () => {
                const grid = document.getElementById('grid-merge');
                grid.innerHTML = '';
                app.state.merge.items.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'spectrum-card';
                    card.draggable = true;
                    
                    // Drag Events
                    card.ondragstart = (e) => { e.dataTransfer.setData('idx', idx); setTimeout(() => card.classList.add('dragging'),0); };
                    card.ondragend = () => { card.classList.remove('dragging'); document.querySelectorAll('.spectrum-card').forEach(c=>c.classList.remove('insert-before','insert-after')); };
                    card.ondragover = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        const rect = card.getBoundingClientRect();
                        const mid = rect.left + rect.width/2;
                        if(e.clientX < mid) { card.classList.add('insert-before'); card.classList.remove('insert-after'); }
                        else { card.classList.add('insert-after'); card.classList.remove('insert-before'); }
                    };
                    card.ondragleave = () => card.classList.remove('insert-before','insert-after');
                    card.ondrop = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        card.classList.remove('insert-before','insert-after');
                        const from = parseInt(e.dataTransfer.getData('idx'));
                        if(isNaN(from) || from === idx) return;
                        let to = idx;
                        const rect = card.getBoundingClientRect();
                        if(e.clientX >= rect.left + rect.width/2) to = idx + 1;
                        if(from < to) to--;
                        
                        const moved = app.state.merge.items.splice(from, 1)[0];
                        app.state.merge.items.splice(to, 0, moved);
                        app.merge.render();
                    };

                    const prev = document.createElement('div');
                    prev.className = 'card-preview';
                    prev.appendChild(item.thumb);
                    
                    const footer = document.createElement('div');
                    footer.className = 'card-footer';
                    footer.innerHTML = `
                        <div class="card-title" title="${item.file.name}">${app.ui.truncate(item.file.name)}</div>
                        <div style="display:flex; gap:4px;">
                            <button class="spectrum-btn icon-only quiet" onclick="app.merge.remove(${idx})"><span class="material-icons-outlined">close</span></button>
                        </div>
                    `;
                    
                    card.append(prev, footer);
                    grid.appendChild(card);
                });
            },
            remove: (idx) => {
                app.state.merge.items.splice(idx, 1);
                app.merge.render();
                document.getElementById('info-merge').textContent = `${app.state.merge.items.length} 份文件`;
                if(app.state.merge.items.length === 0) app.reset('merge');
            },
            execute: async () => {
                if(app.state.merge.items.length < 2) return app.ui.toast('請至少合併兩個檔案', 'error');
                app.ui.loader(true);
                try {
                    const doc = await PDFDocument.create();
                    for(let item of app.state.merge.items) {
                        const src = await PDFDocument.load(item.buffer);
                        const copied = await doc.copyPages(src, src.getPageIndices());
                        copied.forEach(p => doc.addPage(p));
                    }
                    app.download(await doc.save(), 'merged_spectrum.pdf');
                    app.ui.toast('合併成功！');
                } catch(e) { app.ui.toast('合併失敗', 'error'); }
                finally { app.ui.loader(false); }
            }
        },

        // --- 2. Delete Module ---
        delete: {
            init: () => {
                const zone = document.getElementById('upload-delete');
                const input = document.getElementById('input-delete');
                zone.onclick = () => input.click();
                app.setupDrag(zone, input);
                input.onchange = (e) => app.delete.process(e.target.files[0]);
            },
            process: async (file) => {
                if(!file || file.type !== 'application/pdf') return;
                app.ui.loader(true);
                try {
                    app.state.delete.file = file;
                    app.state.delete.buffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(app.state.delete.buffer).promise;
                    app.state.delete.pages = [];
                    for(let i=1; i<=pdf.numPages; i++){
                        const page = await pdf.getPage(i);
                        // --- 修正點：提高渲染比例 (0.4 -> 0.8) ---
                        const viewport = page.getViewport({scale:0.8});
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width; canvas.height = viewport.height;
                        app.fitCanvas(canvas, viewport.width, viewport.height, 0);
                        await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
                        app.state.delete.pages.push({num:i, thumb:canvas, selected:false});
                    }
                    document.getElementById('upload-delete').classList.add('hidden');
                    document.getElementById('work-delete').classList.remove('hidden');
                    document.getElementById('info-delete').textContent = file.name;
                    app.delete.render();
                } catch(e) { console.error(e); app.ui.toast('讀取失敗', 'error'); }
                finally { app.ui.loader(false); }
            },
            render: () => {
                const grid = document.getElementById('grid-delete');
                grid.innerHTML = '';
                app.state.delete.pages.forEach(p => {
                    const card = document.createElement('div');
                    card.className = `spectrum-card ${p.selected ? 'selected' : ''}`;
                    card.onclick = () => { p.selected = !p.selected; app.delete.render(); };
                    card.style.cursor = 'pointer';
                    
                    const prev = document.createElement('div');
                    prev.className = 'card-preview';
                    prev.appendChild(p.thumb);
                    
                    const footer = document.createElement('div');
                    footer.className = 'card-footer';
                    footer.innerHTML = `<div class="card-title" style="width:100%; text-align:center;">Page ${p.num}</div>`;
                    
                    card.append(prev, footer);
                    grid.appendChild(card);
                });
            },
            execute: async () => {
                const keep = app.state.delete.pages.filter(p => !p.selected).map(p => p.num - 1);
                if(keep.length === app.state.delete.pages.length) return app.ui.toast('請選擇要刪除的頁面', 'error');
                app.ui.loader(true);
                try {
                    const src = await PDFDocument.load(app.state.delete.buffer);
                    const doc = await PDFDocument.create();
                    const copied = await doc.copyPages(src, keep);
                    copied.forEach(p => doc.addPage(p));
                    app.download(await doc.save(), 'edited_spectrum.pdf');
                    app.ui.toast('刪除成功');
                } catch(e) { app.ui.toast('儲存失敗', 'error'); }
                finally { app.ui.loader(false); }
            }
        },

        // --- 3. Rotate Module ---
        rotate: {
            init: () => {
                const zone = document.getElementById('upload-rotate');
                const input = document.getElementById('input-rotate');
                zone.onclick = () => input.click();
                app.setupDrag(zone, input);
                input.onchange = (e) => app.rotate.process(e.target.files[0]);
            },
            process: async (file) => {
                if(!file || file.type !== 'application/pdf') return;
                app.ui.loader(true);
                try {
                    app.state.rotate.file = file;
                    app.state.rotate.buffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(app.state.rotate.buffer).promise;
                    app.state.rotate.pages = [];
                    for(let i=1; i<=pdf.numPages; i++){
                        const page = await pdf.getPage(i);
                        // --- 修正點：提高渲染比例 (0.4 -> 0.8) ---
                        const viewport = page.getViewport({scale:0.8});
                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width; canvas.height = viewport.height;
                        app.fitCanvas(canvas, viewport.width, viewport.height, 0);
                        await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
                        app.state.rotate.pages.push({num:i, rotation:0, thumb:canvas, w:viewport.width, h:viewport.height});
                    }
                    document.getElementById('upload-rotate').classList.add('hidden');
                    document.getElementById('work-rotate').classList.remove('hidden');
                    document.getElementById('info-rotate').textContent = file.name;
                    app.rotate.render();
                } catch(e) { app.ui.toast('讀取失敗', 'error'); }
                finally { app.ui.loader(false); }
            },
            render: () => {
                const grid = document.getElementById('grid-rotate');
                grid.innerHTML = '';
                app.state.rotate.pages.forEach((p, idx) => {
                    const card = document.createElement('div');
                    card.className = 'spectrum-card';
                    
                    const prev = document.createElement('div');
                    prev.className = 'card-preview';
                    prev.appendChild(p.thumb);
                    app.fitCanvas(p.thumb, p.w, p.h, p.rotation);
                    
                    const footer = document.createElement('div');
                    footer.className = 'card-footer';
                    footer.innerHTML = `
                        <button class="spectrum-btn icon-only quiet" onclick="app.rotate.turn(${idx}, -90)"><span class="material-icons-outlined">rotate_left</span></button>
                        <span style="font-size:12px; font-weight:600;">${p.num}</span>
                        <button class="spectrum-btn icon-only quiet" onclick="app.rotate.turn(${idx}, 90)"><span class="material-icons-outlined">rotate_right</span></button>
                    `;
                    card.append(prev, footer);
                    grid.appendChild(card);
                });
            },
            turn: (idx, deg) => {
                const p = app.state.rotate.pages[idx];
                p.rotation += deg;
                app.fitCanvas(p.thumb, p.w, p.h, p.rotation);
            },
            execute: async () => {
                app.ui.loader(true);
                try {
                    const src = await PDFDocument.load(app.state.rotate.buffer);
                    const pages = src.getPages();
                    app.state.rotate.pages.forEach((p, i) => {
                        const current = pages[i].getRotation().angle;
                        let final = (current + p.rotation) % 360;
                        if(final < 0) final += 360;
                        pages[i].setRotation(degrees(final));
                    });
                    app.download(await src.save(), 'rotated_spectrum.pdf');
                    app.ui.toast('儲存成功');
                } catch(e) { app.ui.toast('儲存失敗', 'error'); }
                finally { app.ui.loader(false); }
            }
        },

        // --- 4. Image Module ---
        image: {
            init: () => {
                const zone = document.getElementById('upload-image');
                const input = document.getElementById('input-image');
                zone.onclick = () => input.click();
                app.setupDrag(zone, input);
                input.onchange = (e) => app.image.process(Array.from(e.target.files));
            },
            process: (files) => {
                if(!files.length) return;
                app.state.image.files = files;
                const grid = document.getElementById('grid-image');
                grid.innerHTML = '';
                files.forEach((f, i) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const card = document.createElement('div');
                        card.className = 'spectrum-card';
                        const prev = document.createElement('div');
                        prev.className = 'card-preview';
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        prev.appendChild(img);
                        const footer = document.createElement('div');
                        footer.className = 'card-footer';
                        footer.innerHTML = `<div class="card-title">IMG ${i+1}</div>`;
                        card.append(prev, footer);
                        grid.appendChild(card);
                    }
                    reader.readAsDataURL(f);
                });
                document.getElementById('upload-image').classList.add('hidden');
                document.getElementById('work-image').classList.remove('hidden');
                document.getElementById('info-image').textContent = `${files.length} 張圖片`;
            },
            execute: async () => {
                if(!app.state.image.files.length) return;
                app.ui.loader(true);
                try {
                    const doc = await PDFDocument.create();
                    for(let f of app.state.image.files) {
                        const buffer = await f.arrayBuffer();
                        let img;
                        if(f.type === 'image/jpeg') img = await doc.embedJpg(buffer);
                        else img = await doc.embedPng(buffer);
                        const page = doc.addPage([img.width, img.height]);
                        page.drawImage(img, {x:0, y:0, width:img.width, height:img.height});
                    }
                    app.download(await doc.save(), 'images_spectrum.pdf');
                    app.ui.toast('轉換成功');
                } catch(e) { app.ui.toast('轉換失敗', 'error'); }
                finally { app.ui.loader(false); }
            }
        },

        // --- Utilities ---
        // --- 修正點：移除 JS 手動 Scale，依賴 CSS 與 動態 maxWidth 解決旋轉溢出 ---
        fitCanvas: (canvas, w, h, rot) => {
            const isVert = Math.abs(rot) % 180 === 90;
            
            if (isVert) {
                // 90/270度：畫布的 Layout Width 變成視覺 Height。
                // 限制 Layout Width (maxWidth) 為容器可用高度 (220-16=204px)，防止上下溢出。
                // 限制 Layout Height (maxHeight) 為 100%，確保視覺寬度不超過容器寬度。
                canvas.style.maxWidth = '204px'; 
                canvas.style.maxHeight = '100%';
            } else {
                // 0/180度：正常 CSS 限制
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '100%';
            }
            
            canvas.style.transform = `rotate(${rot}deg)`;
        },
        setupDrag: (elem, input) => {
            elem.ondragover = (e) => { e.preventDefault(); elem.style.borderColor = 'var(--spectrum-global-color-blue-500)'; elem.style.backgroundColor = '#f0f8ff'; };
            elem.ondragleave = (e) => { e.preventDefault(); elem.style.borderColor = ''; elem.style.backgroundColor = ''; };
            elem.ondrop = (e) => {
                e.preventDefault();
                elem.style.borderColor = ''; elem.style.backgroundColor = '';
                input.files = e.dataTransfer.files;
                input.dispatchEvent(new Event('change'));
            };
        },
        download: (bytes, name) => {
            const blob = new Blob([bytes], {type:'application/pdf'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = name;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
        }
    };

    window.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'none'; });
        document.addEventListener('drop', e => { e.preventDefault(); });
        app.merge.init();
        app.delete.init();
        app.rotate.init();
        app.image.init();
    });
</script>
</body>
</html>
